1
00:00:02,180 --> 00:00:10,860
El error al que nos enfrentamos aqu tiene que ver con el hecho de que estamos envolviendo nuestro contenedor de aplicaciones

2
00:00:11,490 --> 00:00:20,200
con Connect y eso simplemente rompe nuestro router de reaccin. Podemos solucionarlo fcilmente, aunque tenemos que importar el componente de

3
00:00:20,200 --> 00:00:23,440
orden superior withRouter de reaccionar-enrutador-dom y si

4
00:00:23,880 --> 00:00:29,220
obtiene un error como este que siempre est relacionado con conectar envolviendo

5
00:00:29,220 --> 00:00:36,900
su componente que tambin desea cargar con enrutamiento y, por lo tanto, este componente no recibe los accesorios

6
00:00:36,900 --> 00:00:42,800
de tu ruta, simplemente puedes ajustar la conexin aqu con withRouter as como as.

7
00:00:43,080 --> 00:00:49,000
Y ahora con ese pequeo cambio, withRouter har que tus accesorios se transfieran a tu componente de aplicacin y,

8
00:00:49,000 --> 00:00:54,550
por lo tanto, el enrutador de reaccin volver a la pgina y sabremos qu se est cargando, as

9
00:00:54,660 --> 00:00:56,370
que con eso, estamos trabajando nuevamente.

10
00:00:56,730 --> 00:01:03,730
As que ahora vamos a probar lo que originalmente queramos probar, agregar dnde iniciar sesin aqu, que funciona

11
00:01:03,750 --> 00:01:05,130
bien, ahora en redux

12
00:01:05,130 --> 00:01:11,180
vemos que s logramos iniciar sesin con xito, si echamos un vistazo a la pestaa de

13
00:01:11,280 --> 00:01:14,770
la aplicacin, ver que tenemos estos tres campos poblados.

14
00:01:15,210 --> 00:01:22,900
Ahora djame volver a cargar la aplicacin, ves que se borr y en redux enviamos auth logout, por lo

15
00:01:22,900 --> 00:01:25,220
que esto no est funcionando correctamente.

16
00:01:25,300 --> 00:01:33,550
De alguna manera estamos llegando a esta lnea aqu en nuestro creador de acciones de autenticacin donde despachamos sesin o esta,

17
00:01:33,550 --> 00:01:36,100
tendremos que averiguar cul es, as

18
00:01:36,100 --> 00:01:38,320
que vamos a solucionar esto rpidamente.

19
00:01:38,350 --> 00:01:47,400
Para depurar eso, puede ir a fuentes y all en nuestro origen de carpeta y

20
00:01:47,640 --> 00:01:51,570
sumergirnos en acciones de la tienda, el

21
00:01:51,620 --> 00:01:53,270
archivo de autenticacin.

22
00:01:53,280 --> 00:02:00,410
As que ahora podemos colocar un punto de interrupcin aqu en nuestra funcin authCheckState,

23
00:02:00,530 --> 00:02:04,730
coloquemos uno aqu donde verifiquemos si tenemos un token.

24
00:02:05,170 --> 00:02:13,660
Permtanme ahora ir a autenticar e iniciar sesin de nuevo para que tengamos un token para el futuro y ahora recarguemos la

25
00:02:13,660 --> 00:02:21,680
pgina, ahora nos quedamos atrapados aqu porque el punto de interrupcin entra en accin y buscamos los tokens con xito.

26
00:02:22,480 --> 00:02:29,590
Pasemos a travs de eso, lo convertimos en ese otro bloque porque tenemos un token pero ahora ya vemos que

27
00:02:29,590 --> 00:02:35,230
la fecha de caducidad es un objeto de fecha, por lo que se ve bien.

28
00:02:35,230 --> 00:02:37,880
Entonces la fecha de vencimiento aqu es en el futuro

29
00:02:38,200 --> 00:02:44,020
y lo que sucede aqu es que entramos en ese bloque y tiene mucho sentido porque estoy verificando si la fecha de

30
00:02:44,320 --> 00:02:47,540
vencimiento es ms grande que la fecha actual o actual y, por

31
00:02:47,740 --> 00:02:52,480
supuesto, no quiero para cerrar la sesin en este caso porque ese es exactamente el caso donde el

32
00:02:52,480 --> 00:02:53,230
token es vlido.

33
00:02:53,500 --> 00:02:56,320
As que este es un error lgico que podemos corregir

34
00:02:56,350 --> 00:02:58,180
gracias a la depuracin aqu, entonces lo

35
00:02:58,450 --> 00:03:00,980
que tenemos que hacer es volver a escribir esto,

36
00:03:01,000 --> 00:03:07,420
queremos cerrar la sesin si la fecha de caducidad es ms pequea o igual, aunque es muy poco probable que sea igual a

37
00:03:07,420 --> 00:03:09,130
la fecha actual. Con eso

38
00:03:09,130 --> 00:03:13,570
ahora, si volvemos a la aplicacin, iniciemos sesin de

39
00:03:13,810 --> 00:03:17,670
nuevo, as que hagmoslo rpidamente, inicie sesin y

40
00:03:17,860 --> 00:03:20,470
ahora recarguemos la pgina y

41
00:03:20,630 --> 00:03:27,100
ahora puede ver que tenemos authSuccess aqu pero an seguido por authLogout.

42
00:03:27,440 --> 00:03:33,800
As que, volvamos a solucionar esto, pongamos un punto de interrupcin aqu para descubrir

43
00:03:34,040 --> 00:03:37,910
qu est mal aqu, as que rpidamente agregar

44
00:03:38,750 --> 00:03:43,710
mi cdigo aqu, lo enviar y aqu recargar la aplicacin, lo

45
00:03:43,710 --> 00:03:44,710
incluimos aqu

46
00:03:44,900 --> 00:03:52,040
y ahora si pasamos por eso, vamos al bloque else y hacemos login con xito.

47
00:03:52,060 --> 00:03:54,450
Ahora continuemos con la ejecucin del

48
00:03:55,630 --> 00:03:58,740
cdigo, entonces, por qu terminamos la sesin aqu?

49
00:03:58,840 --> 00:04:01,930
Podra estar relacionado con nuestra funcin

50
00:04:01,930 --> 00:04:04,270
checkAuthTimeout donde tambin despachamos logout.

51
00:04:04,270 --> 00:04:12,090
As que tambin coloquemos un punto de interrupcin aqu en el cierre de sesin para ver si esto se activa de

52
00:04:12,520 --> 00:04:20,600
forma preventiva, as que aqu tambin volver a iniciar sesin, volver a cargar la aplicacin, llegaremos al primer punto de quiebre

53
00:04:20,750 --> 00:04:22,690
aqu, podemos saltearnos, sabemos que

54
00:04:22,700 --> 00:04:23,810
no es as

55
00:04:23,810 --> 00:04:24,940
problema y, de

56
00:04:25,040 --> 00:04:28,120
hecho, ahora llegamos a la segunda en setTimeout.

57
00:04:28,370 --> 00:04:30,180
Aunque esto no debera disparar, el

58
00:04:30,620 --> 00:04:34,190
problema probablemente sea el tiempo de caducidad que configuramos, de modo

59
00:04:34,190 --> 00:04:39,520
que pongamos un punto de interrupcin en setTimeout para llegar al punto en el que est configurado

60
00:04:39,980 --> 00:04:45,950
este temporizador y continuemos por ahora, e intentemos esto una vez ms para averiguar qu valor en realidad est

61
00:04:45,950 --> 00:04:49,690
configurado como tiempo de expiracin all porque ese debe ser el problema.

62
00:04:50,210 --> 00:04:59,300
Entonces, si recargamos nuestra aplicacin aqu, podemos omitir el primer punto de interrupcin y ahora veamos el

63
00:04:59,300 --> 00:05:05,470
tiempo de expiracin, es -10 y tiene sentido que este sea -10.

64
00:05:05,600 --> 00:05:07,360
Aqu obtenemos un par de

65
00:05:07,520 --> 00:05:09,620
errores, as que continuemos por ahora

66
00:05:09,770 --> 00:05:10,920
y solucionmoslos, tambin

67
00:05:10,940 --> 00:05:12,510
borremos el segundo punto de quiebre.

68
00:05:12,950 --> 00:05:19,910
Entonces, cul es nuestro problema? Para verificarAuthTimeout en la parte inferior donde inicio sesin automticamente, paso

69
00:05:19,910 --> 00:05:22,390
la diferencia entre la fecha futura y hoy.

70
00:05:22,610 --> 00:05:25,040
Ahora el problema es que uso getSeconds, quera

71
00:05:25,090 --> 00:05:27,130
usar getTime aqu, ese es el

72
00:05:27,290 --> 00:05:28,910
tiempo en milisegundos, ese es

73
00:05:28,910 --> 00:05:30,750
el gran nmero que quera usar.

74
00:05:31,040 --> 00:05:36,660
Entonces getTime ahora nos da la diferencia correcta en milisegundos,

75
00:05:36,740 --> 00:05:43,010
ahora en nuestra funcin checkAuthTimeout aqu, luego multiplicamos por mil, ahora

76
00:05:43,010 --> 00:05:44,670
eso sera demasiado

77
00:05:44,810 --> 00:05:48,460
grande para que el valor que pasamos

78
00:05:48,640 --> 00:05:58,060
aqu est en segundos, as que ajustar este clculo aqu entre parntesis y divdalo por mil, as.

79
00:05:58,080 --> 00:06:04,780
Entonces, veamos si eso funciona, volvamos a nuestra aplicacin y coloquemos un

80
00:06:04,800 --> 00:06:07,080
punto de interrupcin en

81
00:06:07,080 --> 00:06:16,490
checkAuthTimeout para ver si obtenemos un valor correcto ahora. Con eso permtanme iniciar sesin, con suerte una ltima vez debera funcionar, enviar y

82
00:06:16,890 --> 00:06:17,420
echar un

83
00:06:17,450 --> 00:06:20,140
vistazo, aqu estn 3600 que estamos recibiendo del

84
00:06:20,150 --> 00:06:21,310
servidor, podemos omitir.

85
00:06:21,320 --> 00:06:26,520
Interesante es lo que sucede si ahora iniciamos sesin, all vemos el tiempo de expiracin,

86
00:06:26,660 --> 00:06:27,290
tiene sentido,

87
00:06:27,290 --> 00:06:31,600
est un poco por debajo de 3600 porque han pasado 10 segundos.

88
00:06:31,610 --> 00:06:35,450
Entonces, si continuamos, estamos, por supuesto, conectados como puede ver por el hecho

89
00:06:35,540 --> 00:06:41,570
de que tenemos el botn de cerrar sesin y todava tenemos el almacenamiento local lleno de nuestros datos y eso

90
00:06:41,570 --> 00:06:47,240
permanece all si iniciamos sesin una y otra vez. Sin embargo, si aclaramos esto y volvemos a

91
00:06:47,240 --> 00:06:49,500
iniciar sesin, no hemos iniciado sesin.

92
00:06:49,520 --> 00:06:56,580
As que ahora tenemos esa funcionalidad de inicio de sesin automtico siempre que obtengamos un token vlido que an no ha caducado.

